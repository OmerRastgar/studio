_format_version: "3.0"

services:
  - name: nextjs-app
    url: http://studio-frontend:3000
  
  - name: backend-api
    url: http://studio-backend:4000

  - name: secure-viewer
    url: http://studio-viewer:4001/v1/evidence

  - name: kratos-service
    url: http://studio-kratos:4433

routes:
  # Public: Auth routes (no JWT required)
  - name: auth-routes
    service: backend-api
    paths:
      - /api/auth
    strip_path: false
  
  # Public: Health check
  - name: health-route
    service: backend-api
    paths:
      - /api/health
    strip_path: false

  # Kratos Public API (No JWT)
  - name: kratos-route
    service: kratos-service
    paths:
      - /kratos
    strip_path: true
    preserve_host: true
  
  # Protected: All other API routes
  - name: api-protected
    service: backend-api
    paths:
      - /api
    strip_path: false

  # WebSocket: Socket.IO
  - name: socket-io-route
    service: backend-api
    paths:
      - /socket.io
    strip_path: false
    protocols:
      - http
      - https
  
  # Secure Evidence Viewer
  - name: secure-view-route
    service: secure-viewer
    paths:
      - /api/secure-view
    strip_path: true
  
  # Frontend (public)
  - name: app-route
    service: nextjs-app
    paths:
      - /
    strip_path: false

# Global plugins
plugins:
  - name: cors
    config:
      origins:
        - "http://localhost:3000"
        - "http://localhost:8000"
        - "http://localhost"
        # - "*" # Removed insecure wildcard for production readiness
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
        - PATCH
        - HEAD
      headers:
        - Accept
        - Authorization
        - Content-Type
        - Cookie
        - X-Requested-With
        - X-Forwarded-Proto
      credentials: true
      max_age: 3600

  - name: prometheus
    config:
      per_consumer: false
      status_code_metrics: true
      latency_metrics: true
      bandwidth_metrics: true
      upstream_health_metrics: true

  - name: bot-detection
    config:
      allow:
        - "(Pingdom.com_bot_version_.*)"
        - "(Googlebot/.*)"
      deny:
        - "(.*curl.*)"

  # JWT Verification Plugin
  # Verifies HS256 JWTs issued by backend
  - name: jwt
    route: api-protected
    config:
      claims_to_verify: ["exp"]

  # OPA Authorization for protected API routes
  # Reads user from JWT payload verified by jwt plugin above
  - name: opa
    route: api-protected
    config:
      opa_url: "http://studio-opa:8181"
      policy: "studio.authz.allow"
      timeout: 5000
      allow_on_error: false

  - name: opa
    route: secure-view-route
    config:
      opa_url: "http://studio-opa:8181"
      policy: "studio.authz.allow"
      timeout: 5000
      allow_on_error: false



consumers:
  - username: studio-user
    jwt_secrets:
      - key: studio-idp
        algorithm: HS256
        secret: ${JWT_SECRET} # Injected at runtime