[SERVICE]
    Flush         1
    Log_Level     info
    Daemon        off
    Parsers_File  parsers.conf
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020

# Input from Kong HTTP logs
[INPUT]
    Name              http
    Listen            0.0.0.0
    Port              24224
    Tag               kong.*

# Input from Docker container logs
[INPUT]
    Name              forward
    Listen            0.0.0.0
    Port              24225
    Tag               docker.*

# Input from application logs
[INPUT]
    Name              tail
    Path              /var/log/app/*.log
    Tag               app.*
    Parser            json

# Filter to parse Kong logs
[FILTER]
    Name              parser
    Match             kong.*
    Key_Name          log
    Parser            kong_json
    Reserve_Data      On

# Filter to add metadata
[FILTER]
    Name              modify
    Match             *
    Add               environment production
    Add               service audit-app

# Filter to extract user information from JWT
[FILTER]
    Name              lua
    Match             kong.*
    Script            extract_user.lua
    Call              extract_user_from_jwt

# Output to Loki for log aggregation
[OUTPUT]
    Name              loki
    Match             kong.*
    Host              loki
    Port              3100
    Labels            job=kong, environment=production, service=audit-app
    Label_keys        $client_ip,$request_method,$response_status
    Line_format       json
    Remove_keys       kubernetes,stream

# Output to Loki for application logs
[OUTPUT]
    Name              loki
    Match             app.*
    Host              loki
    Port              3100
    Labels            job=application, environment=production, service=audit-app
    Label_keys        $level,$component,$user_id
    Line_format       json
    Remove_keys       kubernetes,stream

# Output to PostgreSQL for audit logs (keep for database queries)
[OUTPUT]
    Name              pgsql
    Match             kong.*
    Host              postgres
    Port              5432
    User              audituser
    Password          auditpass
    Database          auditdb
    Table             fluent_audit_logs
    Timestamp_Key     timestamp
    Async             false

# Output to PostgreSQL for application logs (keep for database queries)
[OUTPUT]
    Name              pgsql
    Match             app.*
    Host              postgres
    Port              5432
    User              audituser
    Password          auditpass
    Database          auditdb
    Table             fluent_app_logs
    Timestamp_Key     timestamp
    Async             false

# Output to stdout for debugging
[OUTPUT]
    Name              stdout
    Match             *
    Format            json_lines