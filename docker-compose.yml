services:
  # PostgreSQL database
  postgres:
    image: postgres:15
    container_name: audit-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-audituser}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-auditpass}
      POSTGRES_DB: ${POSTGRES_DB:-auditdb}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - default

  # Backend Service (Node.js API)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: studio-backend
    restart: unless-stopped
    ports:
      - "4000:4000"
    depends_on:
      - postgres
    volumes:
      - ./backend:/app
      - /app/node_modules
    command: sh ./scripts/init-dev.sh
    user: root
    environment:
      NODE_ENV: development
      PORT: 4000
      DATABASE_URL: ${DATABASE_URL:-postgresql://${POSTGRES_USER:-audituser}:${POSTGRES_PASSWORD:-auditpass}@postgres:5432/${POSTGRES_DB:-auditdb}}
      JWT_SECRET: ${JWT_SECRET:-your-256-bit-secret-key-here-change-this-in-production}
      # MinIO Configuration
      MINIO_ENDPOINT: minio
      MINIO_PORT: 9000
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-auditace}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-auditace123}
      MINIO_BUCKET: ${MINIO_BUCKET:-evidence}
      MINIO_USE_SSL: "false"
      # Observability
      FLUENT_BIT_URL: ${FLUENT_BIT_URL:-http://fluent-bit:9880/app-logs}
      LOKI_URL: ${LOKI_URL:-http://loki:3100}
      TEMPO_URL: ${TEMPO_URL:-http://tempo:4318/v1/traces}
    networks:
      - default

  # MinIO Object Storage (S3-compatible)
  minio:
    image: minio/minio:latest
    container_name: studio-minio
    restart: unless-stopped
    ports:
      - "9000:9000" # S3 API
      - "9001:9001" # Console
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:-auditace}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:-auditace123}
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    networks:
      - default
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 30s
      timeout: 20s
      retries: 3

  # Frontend Service (Next.js UI)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: dependencies
    container_name: studio-frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    command: sh -c "npm install --legacy-peer-deps && npm run dev"
    environment:
      NODE_ENV: development
      PORT: 3000
      # Backend URL for server-side API proxy (internal Docker network)
      BACKEND_URL: http://studio-backend:4000
      # Observability
      FLUENT_BIT_URL: ${FLUENT_BIT_URL:-http://fluent-bit:9880/app-logs}
      LOKI_URL: ${LOKI_URL:-http://loki:3100}
      TEMPO_URL: ${TEMPO_URL:-http://tempo:4318/v1/traces}
      # API URL (Client-side calls go to Kong)
      NEXT_PUBLIC_API_URL: http://localhost:8000/api
    networks:
      - default

  # OPA Policy Server
  opa:
    build:
      context: ./gateway/opa
      dockerfile: Dockerfile
    container_name: studio-opa
    restart: unless-stopped
    ports:
      - "8181:8181"
    networks:
      - default
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:8181/health" ]
      interval: 10s
      timeout: 5s
      retries: 3

  # Kong API Gateway
  kong:
    image: kong:latest
    container_name: kong-gateway
    restart: unless-stopped
    depends_on:
      - backend
      - frontend
      - opa
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: "/etc/kong/kong.yml"
      KONG_PROXY_LISTEN: "0.0.0.0:8000"
      KONG_ADMIN_LISTEN: "0.0.0.0:8001"
      # Enable custom OPA plugin
      KONG_PLUGINS: "bundled,opa"
      KONG_LUA_PACKAGE_PATH: "/usr/local/custom/?.lua;;"
    ports:
      - "80:8000" # Proxy
      - "8000:8000" # Proxy (Direct)
      - "8001:8001" # Admin
    volumes:
      - ./gateway/kong.yml:/etc/kong/kong.yml:ro
      - ./gateway/plugins/opa:/usr/local/custom/kong/plugins/opa:ro
    networks:
      - default

volumes:
  postgres_data:
  minio_data:


networks:
  default:
    name: core_network
    external: true
