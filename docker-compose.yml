services:
  # PostgreSQL database
  postgres:
    image: postgres:15-alpine
    container_name: postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-auditdb}
      POSTGRES_MULTIPLE_DATABASES: "auditdb,kratos"
    # ports: - Removed for security (use internal network)
    #   - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres-init:/docker-entrypoint-initdb.d
    networks:
      - default

  # Ory Kratos - Identity Management Migration
  kratos-migrate:
    image: oryd/kratos:v1.1.0
    container_name: kratos-migrate
    environment:
      - DSN=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/kratos?sslmode=disable
    volumes:
      - ./kratos:/etc/config/kratos
    entrypoint: /bin/sh /etc/config/kratos/run.sh
    command: -c /tmp/kratos.yml migrate sql -e --yes
    networks:
      - default
    depends_on:
      - postgres

  # Ory Kratos - Identity Management Service
  kratos:
    image: oryd/kratos:v1.1.0
    container_name: studio-kratos
    restart: unless-stopped
    # ports: - Removed for security (access via Kong)
    #   - "4433:4433" # Public API
    #   - "4434:4434" # Admin API
    environment:
      - DSN=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/kratos?sslmode=disable
      - LOG_LEVEL=debug
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - PUBLIC_URL=${PUBLIC_URL:-http://localhost}
      - COOKIE_DOMAIN=${COOKIE_DOMAIN:-localhost}
      - SECRET_COOKIE=${JWT_SECRET}
      - SECRET_DEFAULT=${JWT_SECRET}
    entrypoint: /bin/sh /etc/config/kratos/run.sh
    command: serve -c /tmp/kratos.yml --watch-courier
    volumes:
      - ./kratos:/etc/config/kratos
    networks:
      - default
    depends_on:
      - kratos-migrate
      - postgres

  # MailHog for testing emails (replaces MailSlurper)
  mailhog:
    image: mailhog/mailhog:latest
    container_name: studio-mailhog
    # ports:
    #   - "1025:1025" # SMTP (Internal mostly, but exposed for debug)
    #   - "8025:8025" # UI
    networks:
      - default

  # Backend Service (Node.js API)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: studio-backend
    restart: unless-stopped
    # ports: - Removed for security (access via Kong)
    #   - "4000:4000"
    depends_on:
      - postgres
    volumes:
      - ./backend:/app
      - /app/node_modules
      - ./README.md:/app/README.md
    command: sh ./scripts/init-dev.sh
    user: root
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 4000
      WATCHPACK_POLLING: "true"
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-auditdb}
      JWT_SECRET: ${JWT_SECRET}
      TURNSTILE_SECRET_KEY: ${TURNSTILE_SECRET_KEY}
      # MinIO Configuration
      MINIO_ENDPOINT: minio
      MINIO_PORT: 9000
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      MINIO_BUCKET: ${MINIO_BUCKET:-evidence}
      MINIO_USE_SSL: "false"
      # Neo4j
      NEO4J_AUTH: ${NEO4J_AUTH}
      # Observability
      FLUENT_BIT_URL: ${FLUENT_BIT_URL:-http://fluent-bit:9880/app-logs}
      LOKI_URL: ${LOKI_URL:-http://loki:3100}
      TEMPO_URL: ${TEMPO_URL:-http://tempo:4318/v1/traces}
      KRATOS_PUBLIC_URL: "http://demo.cybergaar.com/kratos"
    extra_hosts:
      - "demo.cybergaar.com:host-gateway"
    networks:
      - default

  # MinIO Object Storage (S3-compatible)
  minio:
    image: minio/minio:latest
    container_name: studio-minio
    restart: unless-stopped
    # ports: - Removed for security
    #   - "9000:9000" # S3 API
    #   - "9001:9001" # Console
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY}
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    networks:
      - default
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 30s
      timeout: 20s
      retries: 3

  # Frontend Service (Next.js UI)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: dependencies
    container_name: studio-frontend
    restart: unless-stopped
    # ports:
    #   - "3000:3000"
    environment:
      NODE_ENV: production
      PORT: 3000
      # Backend URL for server-side API proxy (internal Docker network)
      BACKEND_URL: http://studio-backend:4000
      VIEWER_URL: http://studio-viewer:4001
      # Observability
      FLUENT_BIT_URL: ${FLUENT_BIT_URL:-http://fluent-bit:9880/app-logs}
      LOKI_URL: ${LOKI_URL:-http://loki:3100}
      TEMPO_URL: ${TEMPO_URL:-http://tempo:4318/v1/traces}
      # API URL (Client-side calls go to Kong)
      NEXT_PUBLIC_API_URL: ""
      NEXT_PUBLIC_TURNSTILE_SITE_KEY: ${NEXT_PUBLIC_TURNSTILE_SITE_KEY}
      # Force Webpack to poll for changes (Fixes Windows/Docker sync issues)
      WATCHPACK_POLLING: "true"
      KRATOS_INTERNAL_URL: "http://studio-kratos:4433"
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - /app/.next
    user: root
    command: sh -c "npm run build && npm start"
    extra_hosts:
      - "demo.cybergaar.com:host-gateway"
    networks:
      - default

  # OPA Policy Server
  opa:
    build:
      context: ./gateway/opa
      dockerfile: Dockerfile
    container_name: studio-opa
    restart: unless-stopped
    # ports:
    #   - "8181:8181"
    networks:
      - default
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:8181/health" ]
      interval: 10s
      timeout: 5s
      retries: 3

  # Kong API Gateway
  kong:
    image: kong:latest
    container_name: kong-gateway
    restart: unless-stopped
    depends_on:
      - backend
      - frontend
      - opa
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: "/etc/kong/kong.yml"
      KONG_PROXY_LISTEN: "0.0.0.0:8000, 0.0.0.0:8443 ssl"
      KONG_ADMIN_LISTEN: "0.0.0.0:8001"
      # Enable custom OPA plugin
      KONG_PLUGINS: "bundled,opa,bot-detection,cors,jwt,prometheus"
      KONG_LUA_PACKAGE_PATH: "/usr/local/custom/?.lua;;"
      # Inject JWT Secret for substitution in kong.yml
      JWT_SECRET: ${JWT_SECRET}
      # TLS Configuration
      KONG_SSL_CERT: /etc/secrets/cert.pem
      KONG_SSL_CERT_KEY: /etc/secrets/key.pem
    ports:
      - "80:8000" # Proxy
      # - "8080:8000" # Proxy (Direct)
      # - "8081:8001" # Admin
      - "443:8443" # HTTPS Proxy
    volumes:
      - ./gateway/kong.yml:/etc/kong/kong.template.yml:ro
      - ./gateway/run.sh:/run.sh:ro
      - ./gateway/plugins/opa:/usr/local/custom/kong/plugins/opa:ro
      - ./certs:/etc/secrets:ro
    entrypoint: /bin/sh /run.sh
    command: "kong docker-start"
    networks:
      - default

  # Secure Evidence Viewer
  viewer:
    build:
      context: ./viewer
      dockerfile: Dockerfile
    container_name: studio-viewer
    restart: unless-stopped
    # ports: - Removed for security (access via Kong)
    #   - "4001:4001"
    environment:
      PORT: 4001
      MINIO_ENDPOINT: minio
      MINIO_PORT: 9000
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      MINIO_BUCKET: ${MINIO_BUCKET:-evidence}
      MINIO_USE_SSL: "false"
    networks:
      - default

  # n8n Workflow Automation
  n8n:
    image: n8nio/n8n:latest
    container_name: studio-n8n
    restart: unless-stopped
    # ports: - Exposed for workflow management? Usually yes, but verify. Keeping for now as it has UI.
    # ports:
    #   - "5800:5678"
    environment:
      - N8N_HOST=localhost
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - NODE_ENV=production
      - WEBHOOK_URL=http://localhost:5800/
      - GENERIC_TIMEZONE=UTC
    volumes:
      - n8n_data:/home/node/.n8n
    networks:
      - default

  # Neo4j Graph Database
  neo4j:
    image: neo4j:community
    container_name: studio-neo4j
    restart: unless-stopped
    # ports: - Removed for security
    #   - "7474:7474" # HTTP
    #   - "7687:7687" # Bolt
    environment:
      NEO4J_AUTH: ${NEO4J_AUTH}
      NEO4J_dbms_memory_heap_initial__size: 512m
      NEO4J_dbms_memory_heap_max__size: 2G
    volumes:
      - neo4j_data:/data
    networks:
      - default

  # Redis for BullMQ
  redis:
    image: redis:latest
    container_name: studio-redis
    restart: unless-stopped
    # ports: - Removed for security
    #   - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - default

  # --- Observability Stack ---

  fluent-bit:
    image: fluent/fluent-bit:latest
    container_name: studio-fluent-bit
    restart: unless-stopped
    # ports:
    #   - "9880:9880" # HTTP Input
    volumes:
      - ./observability/fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf
      - ./observability/parsers.conf:/fluent-bit/etc/parsers.conf
    networks:
      - default

  loki:
    image: grafana/loki:latest
    container_name: studio-loki
    restart: unless-stopped
    # ports:
    #   - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - default

  tempo:
    image: grafana/tempo:latest
    container_name: studio-tempo
    restart: unless-stopped
    command: [ "-config.file=/etc/tempo/tempo-local.yaml" ]
    volumes:
      - ./observability/tempo-local.yaml:/etc/tempo/tempo-local.yaml
    # ports:
    #   - "14268:14268" # jaeger ingest
    #   - "3200:3200" # tempo
    #   - "4317:4317" # otlp grpc
    #   - "4318:4318" # otlp http
    #   - "9411:9411" # zipkin
    networks:
      - default

  prometheus:
    image: prom/prometheus:latest
    container_name: studio-prometheus
    restart: unless-stopped
    # ports:
    #   - "9090:9090"
    volumes:
      - ./observability/prometheus.yml:/etc/prometheus/prometheus.yml
    networks:
      - default

  postgres-exporter:
    image: prometheuscommunity/postgres-exporter
    container_name: studio-postgres-exporter
    restart: unless-stopped
    environment:
      DATA_SOURCE_URI: "postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-auditdb}?sslmode=disable"
    networks:
      - default

  redis-exporter:
    image: oliver006/redis_exporter
    container_name: studio-redis-exporter
    restart: unless-stopped
    environment:
      - REDIS_ADDR=redis://redis:6379
    networks:
      - default

volumes:
  postgres_data:
  minio_data:
  n8n_data:
  neo4j_data:
  redis_data:


networks:
  default:
    name: core_network
    driver: bridge
